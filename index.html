<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–¢–µ—Å—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–æ–≤</title>
  <style>
    body {
      background: #111;
      color: white;
      font-family: sans-serif;
      text-align: center;
    }
    select, button {
      margin: 10px;
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      background: rgba(255,255,255,0.2);
      color: white;
    }
    #bar {
      width: 80%;
      height: 25px;
      background: #333;
      margin: 20px auto;
      border-radius: 12px;
      overflow: hidden;
    }
    #level {
      height: 100%;
      width: 0%;
      background: lime;
    }
  </style>
</head>
<body>
  <h2>–í—ã–±–æ—Ä –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ üé§</h2>
  <p>–†–∞–∑–Ω—ã–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω—ã —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –º–æ–≥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –ø–æ-—Ä–∞–∑–Ω–æ–º—É (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –±—Ä–∞—É–∑–µ—Ä–∞)</p>

  <label for="micSelect">–í—ã–±–µ—Ä–∏—Ç–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω:</label><br>
  <select id="micSelect"></select>

  <div id="bar"><div id="level"></div></div>

  <button id="recordBtn">üéô –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å</button>
  <button id="playBtn" disabled>‚ñ∂ –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏</button>
  <button id="echoBtn">üîÑ –≠—Ö–æ (–∑–∞–¥–µ—Ä–∂–∫–∞ 1.5 —Å–µ–∫)</button>

  <audio id="player" controls style="display:none; margin-top:15px;"></audio>

  <script>
    let audioContext, analyser, dataArray, source, mediaRecorder;
    let recordedChunks = [];
    let currentStream = null;

    const micSelect = document.getElementById("micSelect");
    const recordBtn = document.getElementById("recordBtn");
    const playBtn = document.getElementById("playBtn");
    const echoBtn = document.getElementById("echoBtn");
    const player = document.getElementById("player");

    // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω–æ–≤
    async function loadMicList() {
      const devices = await navigator.mediaDevices.enumerateDevices();
      micSelect.innerHTML = "";
      devices.filter(d => d.kind === "audioinput").forEach((device, i) => {
        const option = document.createElement("option");
        option.value = device.deviceId;
        option.text = device.label || `–ú–∏–∫—Ä–æ—Ñ–æ–Ω ${i+1}`;
        micSelect.appendChild(option);
      });
    }

    // –ü–æ–¥–∫–ª—é—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –º–∏–∫—Ä–æ—Ñ–æ–Ω
    async function startMic(deviceId) {
      if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
      }

      currentStream = await navigator.mediaDevices.getUserMedia({
        audio: { deviceId: deviceId ? { exact: deviceId } : undefined }
      });

      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }

      source = audioContext.createMediaStreamSource(currentStream);
      analyser = audioContext.createAnalyser();
      source.connect(analyser);
      dataArray = new Uint8Array(analyser.frequencyBinCount);
      drawLevel();

      // –ó–∞–ø–∏—Å—å
      mediaRecorder = new MediaRecorder(currentStream);
      mediaRecorder.ondataavailable = e => recordedChunks.push(e.data);
      mediaRecorder.onstop = () => {
        const blob = new Blob(recordedChunks, { type: "audio/webm" });
        recordedChunks = [];
        player.src = URL.createObjectURL(blob);
        playBtn.disabled = false;
        player.style.display = "block";
      };

      // –≠—Ö–æ
      echoBtn.onclick = () => {
        const delayNode = audioContext.createDelay(2.0);
        delayNode.delayTime.value = 1.5;
        source.connect(delayNode).connect(audioContext.destination);
      };
    }

    // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —É—Ä–æ–≤–Ω—è
    function drawLevel() {
      requestAnimationFrame(drawLevel);
      if (!analyser) return;
      analyser.getByteFrequencyData(dataArray);
      let volume = dataArray.reduce((a, b) => a + b) / dataArray.length;
      document.getElementById("level").style.width = Math.min(volume, 100) + "%";
    }

    // –ó–∞–ø–∏—Å—å
    recordBtn.addEventListener("click", () => {
      if (mediaRecorder.state === "inactive") {
        recordedChunks = [];
        mediaRecorder.start();
        recordBtn.textContent = "‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å";
        playBtn.disabled = true;
      } else {
        mediaRecorder.stop();
        recordBtn.textContent = "üéô –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å";
      }
    });

    playBtn.addEventListener("click", () => {
      player.play();
    });

    // –°–æ–±—ã—Ç–∏–µ –≤—ã–±–æ—Ä–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
    micSelect.addEventListener("change", () => {
      startMic(micSelect.value);
    });

    // –ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∏ –∑–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞
    (async () => {
      await navigator.mediaDevices.getUserMedia({ audio: true });
      await loadMicList();
      if (micSelect.value) {
        startMic(micSelect.value);
      }
    })();
  </script>
</body>
</html>
